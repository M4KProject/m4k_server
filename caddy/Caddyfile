{
	# on force l’ordre des directives pour éviter les conflits
	order replace after encode
	# order image_filter before file_server
  	# order s3proxy before file_server
	email dev@mediactil.com
}

test.a.m4k.fr {
	respond "test.a.m4k.fr path:{path} query:{query} uri:{uri}"
}

nodered.a.m4k.fr {
	reverse_proxy nodered:1880 {
		header_up X-Forwarded-For {http.request.header.X-Forwarded-For}
		header_up X-Real-IP {remote}
		header_up Host {http.request.host}
	}
}

pb.m4k.fr {
	handle /test/* {
		respond "pb.m4k.fr v1.0.1 path:{path} query:{query} uri:{uri}"
	}

	# Handle API requests - proxy to PocketBase
	handle /api/* {
		request_body {
			max_size 10MB
		}
		reverse_proxy pocketbase:8090 {
			header_up X-Forwarded-For {http.request.header.X-Forwarded-For}
			header_up X-Real-IP {remote}
			header_up Host {http.request.host}
			transport http {
				read_timeout 360s
			}
		}
	}

	# Handle PocketBase admin UI
	handle /_/* {
		request_body {
			max_size 10MB
		}
		reverse_proxy pocketbase:8090 {
			header_up X-Forwarded-For {http.request.header.X-Forwarded-For}
			header_up X-Real-IP {remote}
			header_up Host {http.request.host}
			transport http {
				read_timeout 360s
			}
		}
	}

	# Serve static files from www folder
	handle {
		root * /srv/www
		try_files {path} /index.html
		file_server
	}
	handle {
      root * /srv/www

      # Handle service worker and PWA files specifically
      @sw_files path /sw.js /manifest.webmanifest
      handle @sw_files {
          header Cache-Control "no-cache, no-store, must-revalidate"
          file_server
      }

      # Handle static assets
      @static_files path_regexp \.(js|mjs|css|png|jpg|jpeg|svg|ico|woff|woff2|pdf|mp4|webm|ogg)$
      handle @static_files {
          header Cache-Control "public, max-age=31536000"
          file_server
      }

      # SPA fallback for everything else
      try_files {path} /index.html
      file_server
  }
}

fonts.m4k.fr {
	handle /s/* {
		reverse_proxy https://fonts.gstatic.com {
			header_up Host {upstream_hostport}
		}
	}
	handle_path /v1/* {
		rewrite * /css2?family={path.0}:ital,wght@0,400;0,700;1,400;1,700&display=swap
		reverse_proxy https://fonts.googleapis.com {
			header_up Host {upstream_hostport}
			header_up Accept-Encoding identity
		}
		replace https://fonts.gstatic.com/s https://fonts.m4k.fr/s
	}
	handle {
		respond "fonts.m4k.fr v1.0.1 path:{path} query:{query} uri:{uri}"
	}
}
